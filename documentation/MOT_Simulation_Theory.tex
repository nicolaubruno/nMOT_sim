\documentclass[12pt,a4paper,twoside]{article}
\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage[left=3cm,right=2cm,top=3cm,bottom=2cm]{geometry}
\usepackage{indentfirst}

\usepackage{titleps}
\newpagestyle{main}{
	\sethead[\thepage][\textbf{MOT simulation}][\itshape\sectiontitle] % even
			{\itshape\sectiontitle}{\textbf{MOT simulation}}{\thepage} % odd
	\headrule
	\setfoot[][][]{}{}{}
}
\renewpagestyle{plain}{ %Title page
	\sethead[\thepage][][]{}{}{\thepage}
	\setfoot[][][]{}{}{}
}
\pagestyle{main}

\usepackage{setspace}
\onehalfspacing
\setlength{\parindent}{4em}
\setlength{\parskip}{1em}
\makeatletter
 \def\@textbottom{\vskip \z@ \@plus 1000pt}
 \let\@texttop\relax
\makeatother

\usepackage[hidelinks]{hyperref}

\usepackage{xcolor}
\definecolor{mGreen}{rgb}{0,0.6,0}
\definecolor{mGray}{rgb}{0.5,0.5,0.5}
\definecolor{mPurple}{rgb}{0.58,0,0.82}
\definecolor{backgroundColour}{rgb}{0.95,0.95,0.92}


\usepackage{listings} %For code in appendix
\lstdefinestyle{CStyle}{
    backgroundcolor=\color{backgroundColour},   
    commentstyle=\color{mGreen},
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{mGray},
    stringstyle=\color{mPurple},
    basicstyle=\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    numbers=left,                    
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2,
    language=C
}
\lstdefinestyle{MatlabStyle}{
    backgroundcolor=\color{backgroundColour},   
    commentstyle=\color{mGreen},
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{mGray},
    stringstyle=\color{mPurple},
    basicstyle=\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    numbers=left,                    
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2,
    language=Matlab
}



\author{Ramon Gabriel Teixeira Rosa}
\title{%
\textbf{MOT simulation}\\
\large \textbf{- Code documentation -}}



\begin{document}
{\setstretch{1}
	\maketitle
}

\section{Introduction}

A Magneto-Optical Trap (MOT) can be used on the trapping and cooling of atoms. For high efficiency, MOTs required a fine adjustment of the experimental parameters like laser detuning, intensity and polarization. We propose a computational tool to allow the simulation of such systems and optimization of their parameters.

We simulate the magneto-optical trapping of different species using the Monte Carlo method based on the quantitative treatment of light scattering rates for multiple transitions. The trapping times distribution functions were analyzed and the results were compared to experimental data from the literature.

\section{Methods}

\subsection{Magnetic field and laser beams}

The MOT is generated by a pair of coils on the anti-Helmholtz configuration, producing a quadrupole magnetic field $\vec{B}(\vec{r})$ described as 

\begin{align}
	\vec{B} &= \dfrac{A}{2} \left(x\hat{e_x}\ +\ y\hat{e_y}\ -\ 2z\hat{e_z}\right) \nonumber \\
			&= B\hat{e_B},
	\label{eq.magfield}
\end{align}

\noindent
with $r_{1,2,3}\ \equiv\ x,\ y,\ z$ and $\hat{e}_{1,2,3}\ \equiv\ {\hat{e_x},\ \hat{e_y},\ \hat{e_z}}$, and $A$ is the magnetic field gradient.


The laser beams are assumed to be gaussian, so their intensity profile is given by

\begin{equation}
	I(r_{\perp}) = I_{peak}\cdot \exp\left( -2\dfrac{r_{\perp}^2}{\xi^2} \right),
	\label{eq.gaussianbeam}
\end{equation}

\noindent
where $r_{\perp}$ is the distance to the beam center axis, $I_{peak}$ is the intensity of the peak ($I_{peak} = I(r_{\perp}=0)$), where $\xi$ is the $1/e^2$ beam waist.

We simulate a MOT composed of $N_{beams}$ beams, each beam (of index $k$) with a propagation direction $\hat{e_{k}}$ and a polarization vector $\hat{\psi_k}$, with $k=1,\ 2,\ ...,\ N_{beams}$. For example, a right-handed circular polarized beam propagating upwards would have:

\begin{equation*}
	\hat{e_k} =
	\begin{pmatrix}
		0 \\
		0 \\
		1
	\end{pmatrix}
	\mathrm{,\ and\ }
	\hat{\phi_k} = \dfrac{1}{\sqrt{2}}
	\begin{pmatrix}
		1 \\
		-i \\
		0
	\end{pmatrix}.
\end{equation*}

\noindent
The polarization vectors of each beam are written on the lab frame, so even beams with the same polarization handedness propagating at different directions would have polarization vectors written differently.


\subsection{Polarization-allowed atomic transitions}

An atom experiencing the Zeeman effect of an external magnetic field has a well-defined quantization axis, which is usually defined as $\hat{e_z}$. Using this definition, it is possible to show that transitions with $\Delta m_j=-1,\ 0,\ +1$, namely $\sigma^{-}$, $\pi$, and $\sigma^{+}$ transitions, are only dipole-allowed by the perturbation of electric fields of the form \cite{foot2005atomic}:

\begin{align*}
	& \vec{E}_{\sigma^{-}} = E_0\ e^{i\omega t}\ \dfrac{\hat{e_{x}} - i\hat{e_{y}}}{\sqrt{2}},\\
	& \vec{E}_{\pi} = E_0\ e^{i\omega t}\ \hat{e_z},\\
	& \vec{E}_{\sigma^{+}} = E_0\ e^{i\omega t}\ \dfrac{\hat{e_{x}} + i\hat{e_{y}}}{\sqrt{2}}.
\end{align*}

We define transition vectors as the electric field polarization vectors necessary in order to access those transition, so in this case:

\begin{equation*}
    \hat{\sigma^{-}} = \dfrac{1}{\sqrt{2}}
	\begin{pmatrix}
		1\\
		-i\\
		0
	\end{pmatrix},\ 
	\hat{\pi} = 
	\begin{pmatrix}
		0\\
		0\\
		1
	\end{pmatrix},\ 
	\hat{\sigma^{+}} = \dfrac{1}{\sqrt{2}}
	\begin{pmatrix}
		1\\
		i\\
		0
	\end{pmatrix}.
\end{equation*}


An atom at an arbitrary position will experience a magnetic field $\vec{B} = B\hat{e_B}$ given by the equation~\ref{eq.magfield}, so its quantization axis will be defined by $\hat{e_B}$. The transition unit vectors have to be calculated. We start doing so by defining the $\pi$, which points in the direction of the magnetic field:

\begin{equation}
	\hat{\pi} = \hat{e_B}.
\end{equation}

Now we have to define a new orthogonal basis $\{\hat{h_x},\hat{h_y},\hat{h_z}\}$, where $\hat{h_z} = \hat{e_B}$ and the vector space orientation is positive ($\hat{h_x}\times\hat{h_y} = \hat{h_z}$).

First, we create a random\footnote{For this whole document, the term ``random'' is used loosely and represent pseudo-random numbers generated by deterministic random bit generators.} vector $\hat{q_1}$ (not parallel to $\hat{e_B}$, and orthogonalize it with respect to $\hat{e_B}$:

\begin{equation*}
	\vec{q_1}^{\perp} = \hat{q_1} - \hat{e_B}(\hat{q_1}\cdot\hat{e_B}).
\end{equation*}

\noindent
So we have the first basis vector

\begin{equation}
	\hat{h_1} = \dfrac{\vec{q_1}^{\perp}}{\left| \vec{q_1}^{\perp} \right|},
\end{equation}

and can calculate the second basis vector already imposing the vector space orientation as follows:

\begin{equation}
	\hat{h_2} =	\hat{e_B} \times \hat{h_1}.
\end{equation}

Now, the transition vectors can be written as:

\begin{align}
	& \hat{\sigma^{-}} = \dfrac{1}{\sqrt{2}}\left( \hat{h_1} - i \hat{h_2} \right),
	\label{eq.vecsigmam}
	\\
	& \hat{\pi} = \hat{e_B},
	\label{eq.vecpi}	
	\\	
	& \hat{\sigma^{+}} = \dfrac{1}{\sqrt{2}}\left( \hat{h_1} + i \hat{h_2} \right).
	\label{eq.vecsigmap}
\end{align}



\subsection{Scattering rate, beam selection and recoil}

The scattering rate for an atom considering a single transition with bandwidth $\Gamma$ and a beam with detuning $\delta_0$, intensity $I$ and polarization vector equal to the transition vector is given by\cite{foot2005atomic}:

\begin{equation}
	R  = \dfrac{\Gamma}{2}\dfrac{s}{1 + s + 4\left({\delta_0}/{\Gamma}\right)^2},
\end{equation}

\noindent
where $s = I/I_{sat}$ is the saturation parameter.

In our case, the polarization vectors may not be equal to the transition vectors, so that multiple levels may be coupled by the same excitation beam. We need to calculate the scattering rate $R_{k,u}$ of each beam $k$ related to each transition $u$ (with polarization vector $\hat{u}$) for an atom at an arbitrary position $\vec{r}$. First, we calculate the magnetic field at this position using the equation~\ref{eq.magfield}. We then calculate the transition vectors using equations~\ref{eq.vecsigmam}, \ref{eq.vecpi}, and \ref{eq.vecsigmap}.

The beam electric field can be decomposed in the orthonormal basis of transition vectors. We can calculate the Poynting vector in this basis. The effective saturation parameter for each transition $u$ for each beam $k$ can be calculated by projection of the beam polarization vectors $\hat{\phi_k}$ to $\hat{u}$ squared.

\begin{equation}
	s_{k,u}^{\mathrm{eff}} = s\left|\langle \hat{\phi_k},\hat{u} \rangle\right| ^2,
\end{equation}

\noindent
where 

\begin{equation*}
	\langle \vec{a},\vec{b} \rangle = \sum_{j=1}^{3} a_j^* b_j,
\end{equation*}

\noindent
being $a_j$ (or $b_j$) the $j-th$ coordinate of the vector $\vec{a}$ (or $\vec{b}$), and $a_j^*$ being the complex conjugate of $a_j$.

Additionally, the detuning $delta$ is defined in terms of the unperturbed atom. The atom in our model, however, experience a Zeeman shift on both ground and excited states, so there is a net Zeeman frequency shift $\delta_Z$ equal to:

\begin{equation}
	\delta_Z = \dfrac{\mu_B \left|\vec{B}\right| (g_{J_g} m_J^{\mathrm{gnd}} - g_{J_e} m_J^{\mathrm{exc}})}{h},
\end{equation}

\noindent
where $\mu_B$ is the Bohr magneton, $h$ is the planck constant, $g_{J_g}$ and $g_{J_e}$ are the Landé g-factor of ground and excited states respectively, and $m_J^{\mathrm{gnd}}$ and $m_J^{\mathrm{exc}}$ are the $m_J$ quantum numbers of ground and excited states respectively.

The Doppler effect also plays a role on the effective local detuning. For an atom with velocity $\vec{v}$, a beam propagating at a direction $\hat{e_B}$ and frequency $\nu_0$ at the lab frame, will have a frequency $\nu$ given by

\begin{equation}
	\nu = \nu_0\left( 1 - \dfrac{\vec{v}\cdot{\hat{e_B}}}{c} \right),
\end{equation}

\noindent
where $c$ is the speed of light and we are assuming a non-relativistic limit. If the atom has a velocity that is opposed to the propagation direction of the beam, the light will be blueshifted whereas it will be redshifted otherwise. So, the Doppler effect produces a shift on the laser frequency equal to

\begin{equation}
	\delta_D = - \nu_0\dfrac{\vec{v}\cdot{\hat{e_B}}}{c}.
\end{equation}

The effective local detuning $\delta^{\mathrm{eff}}$ is the contribution of the laser detuning, and the Zeeman and Doppler shifts.

\begin{align}
	\delta_{k,u}^{\mathrm{eff}} &= \delta_0 + \delta_Z + \delta_D \nonumber
	\\
	&= \delta_0 +
	\dfrac{\mu_B \left|\vec{B}\right| (g_{J_g} m_J^{\mathrm{gnd}} - g_{J_e} m_J^{\mathrm{exc}})}{h}
	- \nu_0\dfrac{\vec{v}\cdot{\hat{e_B}}}{c}.
	\label{eq.effdetuning}
\end{align}


Now, we can calculate $R_{k,u}$:

\begin{equation}
	R_{k,u} = \dfrac{\Gamma}{2}\dfrac{s_{k,u}^{\mathrm{eff}}}{1 + s_{k,u}^{\mathrm{eff}} + 4\left(\delta_{k,u}^{\mathrm{eff}} / \Gamma \right)^2}.
	\label{eq.scattrate}
\end{equation}


\subsection{Aditional forces}

The two additional forces being used here are the force of the magnetic field on the atom magnetic dipole, and the gravitational force.

The quantization axis of an atom experiencing an external magnetic field $\vec{B} = B\hat{e_B}$ will be $\hat{e_B}$. The component of its magnetic dipole moment on this direction is given by $\mu_{z'} = g_J m_J \mu_B$:

The magnetic force is given by \cite{berglund2008narrow}

\begin{equation}
	\vec{F}_{mag} = -\nabla \left[ \left(g_J m_J \mu_B\ \hat{e_B}\right) \cdot\vec{B} \right] = - g_J m_J \mu_B \nabla B.
\end{equation}

\noindent
The gradient of the magnetic field strength is given by

\begin{align}
	\nabla B &= \nabla \left( \dfrac{A}{2}\sqrt{x^2 + y^2 - 4z^2} \right) \nonumber \\
	&= \left( \hat{e_x}\dfrac{\partial}{\partial x} + \hat{e_y}\dfrac{\partial}{\partial y} + \hat{e_y}\dfrac{\partial}{\partial y} \right) \left( \dfrac{A}{2}\sqrt{x^2 + y^2 + 4z^2} \right) \nonumber \\
	&= \dfrac{A}{2} \dfrac{1}{2\left( x^2 + y^2 + 4z^2 \right)^{1/2}} \left( 2x\hat{e_x} + 2y\hat{e_y} + 8z\hat{e_z}\right) \nonumber \\
	& = \dfrac{A}{\sqrt{x^2 + y^2 + 4z^2}} \left( \dfrac{x}{2}\hat{e_x} + \dfrac{y}{2}\hat{e_y} + 2z\hat{e_z}\right).
\end{align}

Similarly, for arbitrary magnetic field gradients on each direction,

\begin{equation}
	\vec{B} = G_x x \hat{e_x} + G_y y \hat{e_y} + G_z z \hat{e_z},
\end{equation}
\noindent

the gradient of the magnetic field strength is given by

\begin{equation}
	\nabla B = \dfrac{1}{\sqrt{{G_x}^2 x^2 + {G_y}^2 y^2 + {G_z}^2 z^2}}
	\left(
	{G_x}^2 x \hat{e_x} +
	{G_y}^2 y \hat{e_y} +
	{G_z}^2 z \hat{e_z}
	\right).
\end{equation}

In this case, the condition

\begin{equation}
	\nabla\cdot\vec{B} = G_x + G_y + G_z = 0
\end{equation}

\noindent
must be imposed when defining $G_x$, $G_y$, and $G_z$.

The gravitational force is also relevant to this simulation. It is given by

\begin{equation}
	\vec{F}_g = M\vec{g},
\end{equation}

\noindent
being $M$ the atom mass and $\vec{g}$ the gravitational acceleration.

The total external force is given by

\begin{equation}
	\vec{F}_\mathrm{ext} = \vec{F}_{mag} + \vec{F}_g.
\end{equation}



%\subsection{Scattering and two-body interactions}
%
%...






\section{Simulation}

This Monte Carlo simulation calculates the classical trajectory of an atom in the MOT. The initial conditions for the simulation are described on the next subsection.

\subsection{Initial conditions}

We start by defining an initial position and velocity for the atom. The initial position is a random position following a gaussian probability distribution with width defined by the user.

The inital velocity is also random and follows the Maxwell-Boltzmann distribution for a temperature defined by the user. We do so by setting each cartesian component of the initial velocity to be random following a gaussian distribution of width $\sqrt{k_B T/M}$ centered at zero .

The random numbers following a gaussian distributions are generated using the Box-Muller transformation.\cite{box1958note}

The algorithm for each iteration is described on the next subsection.

\subsection{Stochastic evolution}

The magnetic field at the atom position is calculated using the equation~\ref{eq.magfield}. The effective local detuning $\delta_{k,u}^\mathrm{eff}$ is calculated to each beam $k$ and transition $u$ (the effective may be different for different beams due to the Doppler effect) using equation~\ref{eq.effdetuning}, and then the scattering rate is calculated also for each beam and each transition using equation~\ref{eq.scattrate}.

Having calculated the scattering rate $R_{k,u}$ for each beam and each transition, we then proceed by selecting each beam the atom absorbs. Instead of splitting the simulation time steps into small fractions of the typical scattering times as implemented by Hanley \textit{et al.},\cite{hanley2018quantitative} we speed the simulation by calculating the individual scattering times for each iteration and allowing the iteration time evolution to continuously adapt to the calculated individual scattering time. This way, each iteration represents one photon absorption and one photon emission, without the need of intermediate calculation steps.

The rate equations for absorption and decay have exponential solutions with average lifetimes $\tau_{k,u} = 1/R_{k,u}$. We generate random lifetimes following a probability distribution $P(t) = e^{-t/\tau_{k,u}}$ for each beam and each transition. The pair beam and transition with shorter lifetime, which is the first transition to happen in that given configuration, is chosen.

The random numbers following an exponential distribution are generated by the cumulative distribution inverse transformation method.\cite{LucDevroye} We want to generate random numbers following the normalized distribution:

\begin{equation*}
	P(t) = \dfrac{1}{\tau} e^{-t/\tau}.
\end{equation*}

The cumulative distribution function of $P$ is given by:

\begin{equation*}
	\bar{P}(t') = \int_0^{t'} dt'\ P(t) = 1 - e^{-t'/\tau}.
\end{equation*}

Solving for $t$, we get

\begin{equation*}
	t = -\tau\ ln\left(1 - \bar{P}(t)\right).
\end{equation*}

Replacing the cumulative distribution function $\bar{P}$ on this equation by a random number $\kappa$ following an uniform distribution in the interval $[0,1[$, we get

\begin{equation}
	t_{\mathrm{exp}} = -\tau\ ln\left(1 - \kappa\right),
\end{equation}

\noindent
where $t_{\mathrm{exp}}$ is a random number following an exponential distribution with average $\tau$.

Once the absorbed beam is chosen and the lifetime $\delta t$ is determined, the simulation calculates the next velocity and position of the atom after the time $\delta t$ is passed. The position, velocity, and time at the $n-th$ iteration are:

\begin{equation}
	\vec{r}_n = \vec{r}_{n-1} +
	\vec{v}_{n-1}t + 
	\frac{\vec{F}_\mathrm{ext}}{2M}{\delta t}^2,
\end{equation}

\begin{equation}
	\vec{v}_n = \vec{v}_{n-1} +
	\frac{h}{\lambda}\hat{e_k} -
	\frac{h}{\lambda}\hat{e_r} +
	\frac{\vec{F}_\mathrm{ext}}{M}\delta t,
\end{equation}

\begin{equation}
	t_n = t_{n-1} + \delta t,
\end{equation}

\noindent
where $\hat{e_k}$ is the propagation direction of the absorbed photon and $\hat{e_r}$ is a random unit vector related to the isotropic photon emission, and $\delta t$ is calculated for each iteration.

This process is repeated until determined otherwise by one of the stopping criteria. We used two stopping criteria, which are:

\begin{itemize}
	\item Maximum number of iterations reached;
	\item Atom distance to the MOT center becomes larger than an user defined threshold distance.
\end{itemize}

We define the Trapping Time as the last time value in which the velocity vector is opposed to the position vector, which is $t_n$ for the last $n$ in which $\vec{v}_n\cdot\vec{r}_n < 0$. If the simulation stops due to the first stopping criteria being reached the Trapping Time is meaningless, but in the second case it can be correlated to the trapping efficiency and can be used to optimize the MOT configuration.


\subsection{Simulation output}

An $x$,$y$,$z$ histogram is built during the simulation. A 3-D meshgrid of zeros is created at the start of the execution. At every iteration, the value of the voxel corresponding to the position of the atom is incremented by $\delta t$. An output file consisting of a 2-D dataset generated from the sum of the 3-D histogram in the $y$ direction is created.

The positions history of the atom is not stored as the attempt to do so typically results in stack or heap overflow for simulations with large number of iterations.

The simulation is carried out a number of times defined by the user and the histograms are averaged. The simulation can also be performed while varying parameters like the laser detuning, having multiple averages for each set of parameters that are being varied. The trapping time is also stored for each time the simulation was executed.

We hypothesize that curves of trapping time \textit{versus} detuning can be correlated with curves of number of atoms on the MOT \textit{versus} detuning, as shown by Ilzhofer \textit{et al.}\cite{ilzhofer2018two}


\subsection{Simulation parameters}

The parameters chosen by the user for the simulation are:

\begin{itemize}
	\item Gravity [$m/s^2$];
	\item Magnetic field gradient [$T/m$];
	\item Laser beams propagation directions ($\hat{e_k}$);
	\item Laser detuning [units of $\Gamma$];
	\item Beams polarizations, which can be:
		\subitem "r": Right-handed circular polarization;
		\subitem "l": Left-handed circular polarization;
		\subitem "x": Polarization vector on plane defined by propagation vector and x-axis (polarization vector orthogonal to propagation direction vector);
		\subitem "y": Polarization vector on plane defined by propagation vector and y-axis (polarization vector orthogonal to propagation direction vector);
		\subitem "z": Polarization vector on plane defined by propagation vector and z-axis (polarization vector orthogonal to propagation direction vector);
	\item Beam peak intensity relative to saturation intensity ($I_{peak}/I_{sat}$, being $I_{peak}$ defined on equation~\ref{eq.gaussianbeam});
	\item Gaussian beam $1/e^2$ diameter ($\xi$ on equation~\ref{eq.gaussianbeam}) [$m$].
	\vspace{5 mm}
	\item Atom mass [$kg$];
	\item Transition linewidth [$Hz$];
	\item Transition wavelength [$m$];
	\item $J$ quantum number for ground state;
	\item $J$ quantum number for excited state;
	\item Landé g-factor for ground state;
	\item Landé g-factor for excited state;
	\vspace{5 mm}
	\item Initial position center (gaussian distribution of initial positions will be located on this position);
	\item Standard deviation of gaussian initial position distribution;
	\item Initial velocity offset (Maxwell-Boltzmann distribution will be added of this value);
	\item Temperature (initial velocities will be random and follow Maxwell-Boltzmann velocity distribution);
	\vspace{5 mm}
	\item Maximum number of iterations;
	\item Threshold distance to interrupt simulation;
	\item MOT center coordinates;
	\item Number of configurations to simulate;
	\item Number of averages for each simulation;
	\item Number of bins on each dimension of the position histogram;
\end{itemize}


\section{Implementation}

The simulation was implemented on C. The main code is written bellow.

\subsection{Main code}

\input{maincode.tex}

\subsection{Header file}

The header file \verb|MOTsimHeader_v1.h| contains some functions necessary for the execution of the main code. The header file content is written bellow.

\input{headerfile.tex}

\subsection{Matlab code for visualizing results}

A Matlab function was written to read and plot the results generated during the simulation. The function \verb|MOTsim_ViewResults1.m| is written bellow.

\input{matlabcode.tex}

\bibliographystyle{unsrt}
\bibliography{MOT_Simulation_bib}





\end{document}